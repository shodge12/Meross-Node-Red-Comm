# Meross-Node-Red-Comm

This flow is designed around a multi-ip configured host.  It uses one ip gatway to scan (Ping) for a meross device in config mode. When it find a device (response to 10.10.10.1) it sends packets to configure the device in terms of MQTT server, MQTT Port, WiFi SSID, WiFi Password, and the encription 'key' (used for ALL MQTT messages).  [The Ping node and the following 'In Pairing Mode' can be deleted and the manual input 'Manual Trigger Config' can be used to initiate the configuration] The parameters are all set in the'Meross System Parameters' node near the top center.  Credentials must be set for all MQTT nodes (purple).

Known limitations: The flow was written to post messages without checking for acks or errors.  A simple debug monitor is provided to watch the device communications.  The initial version is written to only talk to a single meross device (Togglex without a array of objects).  A future version may address this ('Meross MQTT 'Togglex' Message Template' will have to be re-written as javascrfipt node as object arrays are a problem in mustache)

How does it work...
After configuring the flow variables above and the MQTT creds, put your device into config mode.  Withing 2 minutes it should automatically detect your device and configure it with the supplied data.  The device will re-boot and log into your MQTT server.  At that point the iinput buttons on the left side can be use to generate on, off, dim, and device info commands.  As stated above, output is shown on the debug monitoring node...

MQTT Server setup...
To make the meross devices talk to a MQTT server, it must be configured to do TLS with a CA certificate.  A Mosquitto config file is provided.

Credits...
This flow is largely based on information from https://github.com/albertogeniola (project MerossIot) and https://github.com/bytespider/Meross (Meross).

Additional Help for Pi users.  On first connect with a new device, from a ssh execute the following to see all avail SSIDs...
sudo iwlist wlan0 scan
Find the 'Meross_xxxxxxx" SSID.  Run
sudo raspi-config
Change the networking configuration, select WiFi and use the SSID from above with no password.  The Pi will join the network and then auto config should run within 2 minutes.  Optionally, you can run the manual config.

If you choose (or do not have the capacity) not to run the the internal wifi to do initial configuration of the device, you will have to provide a method to connect to the wifi hot-spot generated by the meross device.  Then once configuration is complete, you can move the interface back to your internal LAN which has the MQTT broker.
